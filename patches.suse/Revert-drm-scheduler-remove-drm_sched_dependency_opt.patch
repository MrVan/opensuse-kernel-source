From: Michal Kubecek <mkubecek@suse.cz>
Date: Wed, 4 Jan 2023 14:39:33 +0100
Subject: Revert "drm/scheduler: remove drm_sched_dependency_optimized"
Patch-mainline: Never, temporary workaround
References: https://gitlab.freedesktop.org/drm/amd/-/issues/2323

This reverts commit 2cf9886e281678ae9ee57e24a656749071d543bb.

Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
---
 drivers/gpu/drm/scheduler/sched_main.c | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

--- a/drivers/gpu/drm/scheduler/sched_main.c
+++ b/drivers/gpu/drm/scheduler/sched_main.c
@@ -285,6 +285,32 @@ static void drm_sched_job_done_cb(struct dma_fence *f, struct dma_fence_cb *cb)
 	drm_sched_job_done(s_job);
 }
 
+/**
+ * drm_sched_dependency_optimized - test if the dependency can be optimized
+ *
+ * @fence: the dependency fence
+ * @entity: the entity which depends on the above fence
+ *
+ * Returns true if the dependency can be optimized and false otherwise
+ */
+bool drm_sched_dependency_optimized(struct dma_fence* fence,
+				    struct drm_sched_entity *entity)
+{
+	struct drm_gpu_scheduler *sched = entity->rq->sched;
+	struct drm_sched_fence *s_fence;
+
+	if (!fence || dma_fence_is_signaled(fence))
+		return false;
+	if (fence->context == entity->fence_context)
+		return true;
+	s_fence = to_drm_sched_fence(fence);
+	if (s_fence && s_fence->sched == sched)
+		return true;
+
+	return false;
+}
+EXPORT_SYMBOL(drm_sched_dependency_optimized);
+
 /**
  * drm_sched_start_timeout - start timeout for reset worker
  *
