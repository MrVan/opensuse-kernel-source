#!/bin/bash -e

Red="$(tput setaf 1)$(tput bold)"
red=$(tput setaf 1)
grn=$(tput setaf 2)
brn=$(tput setaf 3)
blu=$(tput setaf 4)
nrm=$(tput sgr0)

sn="${0##*/}"
if [ $# -lt 1 ]; then
    printf "${Red}usage:${nrm} %s <product> [branch]\n" "$sn" >&2
    exit 1
fi
tbranch="$1"
prod="${1%-LTSS}"
branch="${2:-$tbranch}"

OSC_DIR="${OSC_DIR:-/tmp}"
OSC="osc -A https://api.suse.de/"
target="SUSE:SLE-${prod#SLE}:Update"
prj="Devel:Kernel:${tbranch}:Submit"

if [ ! -d "$KSOURCE_GIT" ]; then
    printf "${Red}Error: directory '%s' does not exist${nrm}\n" "$KSOURCE_GIT"
    echo "Please set KSOURCE_GIT to the location of local kernel-source repository."
    exit 1
fi
if [ ! -d "$OSC_DIR" ]; then
    printf "${Red}Error: directory '%s' does not exist${nrm}\n" "$OSC_DIR"
    echo "Please set OSC_DIR to a directory to use for OBS/IBS checkouts."
    exit 1
fi

cd "$KSOURCE_GIT"
git checkout "$branch"
git pull --ff-only >/dev/null
version=$(rpm/compute-PATCHVERSION.sh --patches .)
upd=$($OSC ls "$target" \
    | sed -rne "/^kernel-livepatch-${prod}_Update_[[:digit:]]+\$/ { s/^.*_// ; p }" \
    | sort -n | tail -1)
: $[upd++]

printf "Product:           ${blu}%s${nrm}\n" "$prod"
printf "Target branch:     ${blu}%s${nrm}\n" "$tbranch"
printf "Submission branch: ${blu}%s${nrm}\n" "$branch"
printf "Commit:            ${grn}%s${nrm}\n" \
  $(git --no-pager show -s --pretty='%h' "$branch")
printf "Version: ${blu}%s${nrm}\n" "$version"
printf "Update:  ${blu}%u${nrm}\n" "$upd"
echo

if ! git merge-base --is-ancestor "$branch" "$tbranch"; then
    printf "${Red}Warning: %s not merged into %s${nrm}\n\n" "$branch" "$tbranch" >&2
fi

printf "${grn}* Delete old %s IBS project...${nrm}" "$prj"
$OSC rdelete -f -r -m "drop old maintenance update" "$prj" || true
rm -rf "${OSC_DIR}/${prj}"

echo "${grn}* Pack kernel-source...${nrm}"
cd $KSOURCE_GIT
git clean -dfxq
scripts/tar-up.sh
printf "${grn}* Create %s and upload kernel-source to IBS...${nrm}\n" "$prj"
scripts/osc_wrapper upload --ibs --debug "$prj"

cd "$OSC_DIR"
chanprj="SUSE:Channels"
smlp="SLE-Module-Live-Patching_${prod#SLE}_"
archs=''
while read a; do
    archs="${archs}${archs:+ }${a#${smlp}}"
done < <($OSC ls "$chanprj" | egrep "^$smlp")
old_upd="${prod}_Update_$[upd-1]"
inc_upd="s/${old_upd}/${prod}_Update_${upd}/g"
fixme="s/(${version//./_})-[[:digit:]_]+-/\1-FIXME-/"

printf "${grn}* Copy kernel-livepatch-%s_Update_%u package...${nrm}\n" \
    "$prod" "$upd"
$OSC copypac "Devel:kGraft:patches:${prod}_Update_${upd}" \
    "kernel-livepatch-${prod}_Update_${upd}" "$prj"
printf "${grn}* Branch %s* and update _channel...${nrm}\n" "$smlp"
for a in $archs; do
    printf "${grn}  * architecture %s...${nrm}\n" "$a"
    $OSC bco "$chanprj" "${smlp}${a}" "$prj"
    pushd "${prj}/${smlp}${a}" >/dev/null
    sed -re "/${old_upd}/ { p ; ${inc_upd} ; ${fixme} }" -i _channel
    $OSC commit -m "update channel file"
    popd >/dev/null
done

echo -e "\n\nTo submit the update, run\n"
printf "${red}  %s mr %s \\\\\n" "$OSC" "$prj"
printf "      kernel-source \\\\\n"
printf "      kernel-livepatch-%s_Update_%u \\\\\n" "$prod" "$upd"
while read p; do
    printf "      %s \\\\\n" "$p"
done < <($OSC ls "$prj" | egrep "^$smlp")
printf "      %s${nrm}\n\n" "$target"
